(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[875],{2811:function(e,r,a){(window.__NEXT_P=window.__NEXT_P||[]).push(["/admin/usuarios",function(){return a(5700)}])},5376:function(e,r,a){"use strict";a.d(r,{Z:function(){return t}});var o=a(5893),i=a(1163),l=a(7294);function t(){let[e,r]=(0,l.useState)(null),a=(0,i.useRouter)();if((0,l.useEffect)(()=>{let e=localStorage.getItem("user");e?r(JSON.parse(e)):a.push("/login")},[a]),!e)return null;let t=[];return"admin"===e.role?t.push({label:"Dashboard",href:"/dashboard"},{label:"Gesti\xf3n de Usuarios",href:"/admin/usuarios"},{label:"Gesti\xf3n de Empresas",href:"/admin/empresas"},{label:"Mis Clientes",href:"/cliente/clientes"},{label:"Carga Masiva",href:"/cliente/carga-masiva"},{label:"Barridos",href:"/admin/barridos"},{label:"Matrices de Riesgo",href:"/admin/matrices"},{label:"Cambiar Contrase\xf1a",href:"/cambiar-contrasena"}):"consultor"===e.role?t.push({label:"Dashboard",href:"/dashboard"},{label:"Empresas",href:"/consultor/empresas"},{label:"Mis Clientes",href:"/cliente/clientes"},{label:"Carga Masiva",href:"/cliente/carga-masiva"},{label:"Alertas",href:"/consultor/alertas"},{label:"Reportes",href:"/consultor/reportes"},{label:"Cambiar Contrase\xf1a",href:"/cambiar-contrasena"}):"cliente"===e.role&&t.push({label:"Dashboard",href:"/dashboard"},{label:"Mis Clientes",href:"/cliente/clientes"},{label:"Carga Masiva",href:"/cliente/carga-masiva"},{label:"Transacciones",href:"/cliente/transacciones"},{label:"Reportes",href:"/cliente/reportes"},{label:"Cambiar Contrase\xf1a",href:"/cambiar-contrasena"}),(0,o.jsxs)("nav",{style:{backgroundColor:"#1e40af",padding:"1rem",color:"white",display:"flex",justifyContent:"space-between",alignItems:"center"},children:[(0,o.jsx)("div",{children:(0,o.jsx)("h2",{style:{margin:0,fontSize:"1.2rem"},children:"admin"===e.role?"Consola Administrativa":"consultor"===e.role?"Panel Consultor":"Portal Cliente"})}),(0,o.jsxs)("div",{children:[(0,o.jsxs)("div",{style:{marginBottom:"0.5rem",fontSize:"0.9rem"},children:[e.email," (",e.role,")"]}),(0,o.jsxs)("div",{style:{display:"flex",gap:"1rem"},children:[t.map(e=>(0,o.jsx)("button",{onClick:()=>a.push(e.href),style:{color:"white",background:"none",border:"none",cursor:"pointer",textDecoration:a.pathname===e.href?"underline":"none"},children:e.label},e.href)),(0,o.jsx)("button",{onClick:()=>{localStorage.removeItem("token"),localStorage.removeItem("user"),a.push("/login")},style:{color:"#f87171",background:"none",border:"none",cursor:"pointer"},children:"Cerrar Sesi\xf3n"})]})]})]})}},5700:function(e,r,a){"use strict";a.r(r),a.d(r,{default:function(){return d}});var o=a(5893),i=a(7294),l=a(1163),t=a(7066),n=a(5376);let s="admin@cumplimiento.com";function d(){let[e,r]=(0,i.useState)([]),[a,d]=(0,i.useState)([]),[c,u]=(0,i.useState)(""),[m,p]=(0,i.useState)(!1),[h,b]=(0,i.useState)(!1),[g,x]=(0,i.useState)(null),[v,f]=(0,i.useState)({email:"",password:"",nombre_completo:"",rol:"cliente",empresa_id:""}),[j,y]=(0,i.useState)(!1),[C,w]=(0,i.useState)(null),[k,_]=(0,i.useState)(null),S=(0,l.useRouter)();(0,i.useEffect)(()=>{let e=localStorage.getItem("token"),a=JSON.parse(localStorage.getItem("user")||"{}");if(!e||"admin"!==a.role){S.push("/login");return}(async()=>{try{let[a,o]=await Promise.all([t.Z.get("/api/admin/usuarios",{headers:{Authorization:"Bearer ".concat(e)}}),t.Z.get("/api/admin/empresas",{headers:{Authorization:"Bearer ".concat(e)}})]);r(a.data.usuarios),d(o.data.empresas)}catch(e){var a,o;u((null===(o=e.response)||void 0===o?void 0:null===(a=o.data)||void 0===a?void 0:a.error)||"Error al cargar datos")}})()},[S]);let E=e=>{let{name:r,value:a}=e.target;f(e=>({...e,[r]:a}))},R=e=>{var r;x(e.id),f({email:e.email,password:"",nombre_completo:e.nombre_completo,rol:e.rol,empresa_id:(null===(r=e.empresa_id)||void 0===r?void 0:r.toString())||""}),b(!0)},B=async(e,a)=>{if(a===s){alert("El usuario ra\xedz no puede ser desactivado.");return}if(!confirm("\xbfEst\xe1 seguro de desactivar este usuario?"))return;let o=localStorage.getItem("token");try{await t.Z.put("/api/admin/usuarios/".concat(e),{activo:!1},{headers:{Authorization:"Bearer ".concat(o)}}),r(r=>r.map(r=>r.id===e?{...r,activo:!1}:r))}catch(e){var i,l;u((null===(l=e.response)||void 0===l?void 0:null===(i=l.data)||void 0===i?void 0:i.error)||"Error al desactivar usuario")}},z=async(e,a)=>{if(a===s){alert("El usuario ra\xedz ya est\xe1 activo.");return}if(!confirm("\xbfEst\xe1 seguro de reactivar este usuario?"))return;let o=localStorage.getItem("token");try{await t.Z.put("/api/admin/usuarios/".concat(e),{activo:!0},{headers:{Authorization:"Bearer ".concat(o)}}),r(r=>r.map(r=>r.id===e?{...r,activo:!0}:r))}catch(e){var i,l;u((null===(l=e.response)||void 0===l?void 0:null===(i=l.data)||void 0===i?void 0:i.error)||"Error al reactivar usuario")}},A=(e,r)=>{if(r===s){alert("No se puede restablecer la contrase\xf1a del usuario ra\xedz.");return}w(e),_(null),y(!0)},I=async()=>{if(!C)return;let e=localStorage.getItem("token");try{let r=await t.Z.post("/api/admin/usuarios/".concat(C,"/reset-password"),{},{headers:{Authorization:"Bearer ".concat(e)}});_({email:r.data.email,password:r.data.temporalPassword})}catch(e){var r,a;u((null===(a=e.response)||void 0===a?void 0:null===(r=a.data)||void 0===r?void 0:r.error)||"Error al restablecer contrase\xf1a"),y(!1)}},N=async a=>{a.preventDefault();let o=localStorage.getItem("token");p(!0),u("");try{if(g){let r=e.find(e=>e.id===g);if((null==r?void 0:r.email)===s&&("admin"!==v.rol||!v.email||!v.nombre_completo)){alert("El usuario ra\xedz no puede modificar su rol ni dejar campos vac\xedos."),p(!1);return}let a={email:v.email,nombre_completo:v.nombre_completo,rol:v.rol};"cliente"===v.rol&&(a.empresa_id=v.empresa_id?Number(v.empresa_id):null),await t.Z.put("/api/admin/usuarios/".concat(g),a,{headers:{Authorization:"Bearer ".concat(o)}})}else{let e={...v,empresa_id:"cliente"===v.rol&&v.empresa_id?Number(v.empresa_id):null};await t.Z.post("/api/admin/usuarios",e,{headers:{Authorization:"Bearer ".concat(o)}})}let a=await t.Z.get("/api/admin/usuarios",{headers:{Authorization:"Bearer ".concat(o)}});r(a.data.usuarios),b(!1)}catch(e){var i,l;u((null===(l=e.response)||void 0===l?void 0:null===(i=l.data)||void 0===i?void 0:i.error)||"Error al guardar usuario")}finally{p(!1)}};return(0,o.jsxs)("div",{children:[(0,o.jsx)(n.Z,{}),(0,o.jsxs)("div",{style:{padding:"2rem",fontFamily:"sans-serif"},children:[(0,o.jsxs)("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:"1rem"},children:[(0,o.jsx)("h1",{children:"Gesti\xf3n de Usuarios"}),(0,o.jsx)("button",{onClick:()=>{x(null),f({email:"",password:"",nombre_completo:"",rol:"cliente",empresa_id:""}),b(!0)},style:{padding:"0.5rem 1rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Crear Usuario"})]}),c&&(0,o.jsx)("p",{style:{color:"red",marginBottom:"1rem"},children:c}),(0,o.jsxs)("table",{style:{width:"100%",borderCollapse:"collapse",border:"1px solid #ccc"},children:[(0,o.jsx)("thead",{children:(0,o.jsxs)("tr",{children:[(0,o.jsx)("th",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:"ID"}),(0,o.jsx)("th",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:"Email"}),(0,o.jsx)("th",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:"Nombre"}),(0,o.jsx)("th",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:"Rol"}),(0,o.jsx)("th",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:"Empresa"}),(0,o.jsx)("th",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:"Activo"}),(0,o.jsx)("th",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:"Acciones"})]})}),(0,o.jsx)("tbody",{children:e.map(e=>(0,o.jsxs)("tr",{children:[(0,o.jsx)("td",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:e.id}),(0,o.jsx)("td",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:e.email}),(0,o.jsx)("td",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:e.nombre_completo}),(0,o.jsx)("td",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:e.rol}),(0,o.jsx)("td",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:e.empresa_id||"—"}),(0,o.jsx)("td",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:e.activo?"✅":"❌"}),(0,o.jsxs)("td",{style:{border:"1px solid #ccc",padding:"0.5rem"},children:[(0,o.jsx)("button",{onClick:()=>R(e),style:{marginRight:"0.5rem",padding:"0.25rem 0.5rem",backgroundColor:"#3b82f6",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Editar"}),e.activo?(0,o.jsx)("button",{onClick:()=>B(e.id,e.email),disabled:e.email===s,style:{marginRight:"0.5rem",padding:"0.25rem 0.5rem",backgroundColor:e.email===s?"#9ca3af":"#ef4444",color:"white",border:"none",borderRadius:"4px",cursor:e.email===s?"not-allowed":"pointer"},children:"Desactivar"}):(0,o.jsx)("button",{onClick:()=>z(e.id,e.email),disabled:e.email===s,style:{marginRight:"0.5rem",padding:"0.25rem 0.5rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Reactivar"}),(0,o.jsx)("button",{onClick:()=>A(e.id,e.email),disabled:e.email===s,style:{padding:"0.25rem 0.5rem",backgroundColor:"#8b5cf6",color:"white",border:"none",borderRadius:"4px",cursor:e.email===s?"not-allowed":"pointer"},children:"Restablecer"})]})]},e.id))})]}),h&&(0,o.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0,0,0,0.5)",display:"flex",justifyContent:"center",alignItems:"center"},children:(0,o.jsxs)("div",{style:{backgroundColor:"white",padding:"2rem",borderRadius:"8px",width:"500px",maxHeight:"80vh",overflowY:"auto"},children:[(0,o.jsx)("h2",{children:g?"Editar Usuario":"Crear Usuario"}),(0,o.jsxs)("form",{onSubmit:N,children:[(0,o.jsx)("div",{style:{marginBottom:"1rem"},children:(0,o.jsxs)("label",{children:["Email: ",(0,o.jsx)("input",{name:"email",value:v.email,onChange:E,required:!0,style:{width:"100%",padding:"0.5rem",marginTop:"0.25rem"}})]})}),!g&&(0,o.jsx)("div",{style:{marginBottom:"1rem"},children:(0,o.jsxs)("label",{children:["Contrase\xf1a: ",(0,o.jsx)("input",{name:"password",type:"password",value:v.password,onChange:E,required:!0,style:{width:"100%",padding:"0.5rem",marginTop:"0.25rem"}})]})}),(0,o.jsx)("div",{style:{marginBottom:"1rem"},children:(0,o.jsxs)("label",{children:["Nombre completo: ",(0,o.jsx)("input",{name:"nombre_completo",value:v.nombre_completo,onChange:E,required:!0,style:{width:"100%",padding:"0.5rem",marginTop:"0.25rem"}})]})}),(0,o.jsx)("div",{style:{marginBottom:"1rem"},children:(0,o.jsxs)("label",{children:["Rol:",(0,o.jsxs)("select",{name:"rol",value:v.rol,onChange:E,style:{width:"100%",padding:"0.5rem",marginTop:"0.25rem"},children:[(0,o.jsx)("option",{value:"admin",children:"Administrador"}),(0,o.jsx)("option",{value:"consultor",children:"Consultor"}),(0,o.jsx)("option",{value:"cliente",children:"Cliente"})]})]})}),"cliente"===v.rol&&(0,o.jsx)("div",{style:{marginBottom:"1rem"},children:(0,o.jsxs)("label",{children:["Empresa:",(0,o.jsxs)("select",{name:"empresa_id",value:v.empresa_id,onChange:E,required:!0,style:{width:"100%",padding:"0.5rem",marginTop:"0.25rem"},children:[(0,o.jsx)("option",{value:"",children:"Seleccionar..."}),a.map(e=>(0,o.jsx)("option",{value:e.id,children:e.nombre_legal},e.id))]})]})}),(0,o.jsxs)("div",{style:{display:"flex",gap:"1rem"},children:[(0,o.jsx)("button",{type:"submit",disabled:m,style:{padding:"0.5rem 1rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:m?"Guardando...":g?"Actualizar":"Crear"}),(0,o.jsx)("button",{type:"button",onClick:()=>b(!1),style:{padding:"0.5rem 1rem",backgroundColor:"#6b7280",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Cancelar"})]})]})]})}),j&&(0,o.jsx)("div",{style:{position:"fixed",top:0,left:0,width:"100%",height:"100%",backgroundColor:"rgba(0,0,0,0.5)",display:"flex",justifyContent:"center",alignItems:"center"},children:(0,o.jsxs)("div",{style:{backgroundColor:"white",padding:"2rem",borderRadius:"8px",width:"400px"},children:[(0,o.jsx)("h2",{children:"Restablecer Contrase\xf1a"}),k?(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("p",{children:(0,o.jsx)("strong",{children:"\xa1Contrase\xf1a restablecida!"})}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Email:"})," ",k.email]}),(0,o.jsxs)("p",{children:[(0,o.jsx)("strong",{children:"Nueva contrase\xf1a:"})," ",(0,o.jsx)("code",{children:k.password})]}),(0,o.jsx)("p",{style:{color:"red",fontSize:"0.9rem"},children:"Entregue esta contrase\xf1a al usuario y p\xeddale que la cambie al iniciar sesi\xf3n."}),(0,o.jsx)("button",{onClick:()=>y(!1),style:{marginTop:"1rem",padding:"0.5rem 1rem",backgroundColor:"#10b981",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Cerrar"})]}):(0,o.jsxs)(o.Fragment,{children:[(0,o.jsx)("p",{children:"\xbfEst\xe1 seguro de restablecer la contrase\xf1a de este usuario?"}),(0,o.jsxs)("div",{style:{display:"flex",gap:"1rem",marginTop:"1rem"},children:[(0,o.jsx)("button",{onClick:I,style:{padding:"0.5rem 1rem",backgroundColor:"#8b5cf6",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Confirmar"}),(0,o.jsx)("button",{onClick:()=>y(!1),style:{padding:"0.5rem 1rem",backgroundColor:"#6b7280",color:"white",border:"none",borderRadius:"4px",cursor:"pointer"},children:"Cancelar"})]})]})]})})]})]})}},1163:function(e,r,a){e.exports=a(9090)}},function(e){e.O(0,[66,888,774,179],function(){return e(e.s=2811)}),_N_E=e.O()}]);